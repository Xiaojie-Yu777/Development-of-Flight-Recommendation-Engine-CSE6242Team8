<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Flight Search and Delay Prediction Engine</title>
    <link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css" />
    <script type="module">
        import { loadPyodide } from 'https://cdn.jsdelivr.net/pyodide/v0.25.1/full/pyodide.mjs';
        

        // Define a function to trigger Python function via Pyodide

        async function main() {
            window.pyodide = await loadPyodide();
            console.log("Pyodide is loaded and ready.");
            await window.pyodide.runPythonAsync(`
                from js import document, console
                import json
                from pyodide.http import pyfetch
                from datetime import datetime
                import pyodide_js
                await pyodide_js.loadPackage('requests')
                import requests
                await pyodide_js.loadPackage('ssl')
                import ssl
                await pyodide_js.loadPackage('pandas')
                import pandas as pd
                import urllib.request
                import urllib.error
                import os
                
                async def fetchFlightData():
                    source = document.getElementById('sourceAirportCode').value
                    destination = document.getElementById('destinationAirportCode').value
                    date = document.getElementById('outDate').value
                    console.log("Date being sent to API:", date)  # Debugging line
                    classOfService = document.getElementById('classOfService').value
                    sortOrder = document.getElementById('sortOrder').value
                    itineraryType = document.getElementById('itineraryType').value

                    api_key = "04add5b7cdmshd4b470181d45798p1428bbjsn3f4be7e144f4"
                    api_host = "tripadvisor16.p.rapidapi.com"
                    url = "https://tripadvisor16.p.rapidapi.com/api/v1/flights/searchFlights"

                    querystring = {
                        "sourceAirportCode": source,
                        "destinationAirportCode": destination,
                        "date": date,
                        "itineraryType": itineraryType,
                        "sortOrder": sortOrder,
                        "classOfService": classOfService,
                        "pageNumber": '1',
                        "currencyCode": 'USD'
                    }

                    headers = {
                        'x-rapidapi-key': '04add5b7cdmshd4b470181d45798p1428bbjsn3f4be7e144f4',
                        'x-rapidapi-host': 'tripadvisor16.p.rapidapi.com'
                    }


                    response = requests.get(url, headers=headers, params=querystring, verify=False)
                    response_text = json.loads(response.text)

                    if 'data' not in response_text:
                        console.error('API response does not contain data:', json.dumps(response_text))
                        return []

                    flights_data = []
                    for flight in response_text['data']['flights']:
                        segments = flight['segments']
                        for segment in segments:
                            legs = segment['legs']
                            for leg in legs:
                                departure_time = datetime.fromisoformat(leg['departureDateTime'])
                                arrival_time = datetime.fromisoformat(leg['arrivalDateTime'])
                                air_time_minutes = (arrival_time - departure_time).total_seconds() / 60
                                
                                departure_datetime = datetime.fromisoformat(leg['departureDateTime'])
                                fl_date = departure_datetime.strftime("%Y-%m-%d")
                                
                                flight_info = {
                                    'FL_DATE': fl_date,
                                    'AIRLINE': flight['purchaseLinks'][0]['partnerSuppliedProvider']['displayName'],
                                    'AIRLINE_CODE': leg['operatingCarrier']['code'],
                                    'FL_NUMBER': leg['flightNumber'],
                                    'ORIGIN': leg['originStationCode'],
                                    'DEST': leg['destinationStationCode'],
                                    'AIR_TIME': air_time_minutes,
                                    'DISTANCE': leg['distanceInKM'],
                                    #'total_price': flight['purchaseLinks'][0]['totalPrice'],  # Assuming only one purchase link per flight
                                    'ARR_DELAY': "0",
                                    'CANCELLED': "0"
                                }
                                flights_data.append(flight_info)
                    flights_data = pd.DataFrame(flights_data)
                    return flights_data
                
                async def allowSelfSignedHttps(allowed):
                    if allowed and not os.environ.get('PYTHONHTTPSVERIFY', '') and getattr(ssl, '_create_unverified_context', None):
                        ssl._create_default_https_context = ssl._create_unverified_context

                allowSelfSignedHttps(True)  # Allow self-signed certificates (for development only)
                # Continue from your previous fetchFlightData function...
                async def fetchFlightDelays(flights_data):
                    # Assuming flights_data is a list of dictionaries
                    url = 'http://d16ea803-be49-45c8-a407-8b01a550f87e.eastus2.azurecontainer.io/score';
                    api_key = 'MJ62jbpd130GjJbvoMrI7hHS3PCzIPVm';  

                    headers = {
                        'Content-Type': 'application/json',
                        'Authorization': ('Bearer ' + api_key),
                        'Access-Control-Allow-Origin': "http://localhost:8000",
                        'Accept': '*/*'
                    };
                                
                    data = {
                        "Inputs": {
                            "input1": flights_data.to_json(orient='records')  # Convert DataFrame to JSON string
                        },
                        "GlobalParameters": {}
                    };

                    # Convert the Python dictionary to a JSON string
                    body = json.dumps(data)

                    try:
                        req = urllib.request.Request(url, data=body.encode(), headers=headers)
                        response = urllib.request.urlopen(req)
                        result_json = response.read().decode('utf-8')
                        results = json.loads(result_json).get('Results', {}).get('WebServiceOutput0', None)
                        if results is not None:
                            return results
                        else:
                            console.error("No prediction results found in the response")
                            return None
                    except urllib.error.HTTPError as error:
                        console.error(f"Failed to fetch data: HTTP {error.code}")
                        console.error(error.info())
                        console.error(error.read().decode("utf8", 'ignore'))
                        return None
                    except Exception as e:
                        console.error(f"An error occurred while fetching delay predictions: {str(e)}")
                        return None

                async def fetchAndDisplayFlights():
                    flight_info = await fetchFlightData();
                    data = await fetchFlightDelays(flight_info);
                    if data:
                        output_html = '<table border="1"><tr><th>Date</th><th>Airline</th><th>Flight Number</th><th>Origin</th><th>Destination</th><th>Air Time</th><th>Distance (KM)</th></tr>'
                        for flight in data:
                            output_html += f'<tr><td>{flight["FL_DATE"]}</td><td>{flight["AIRLINE"]}</td><td>{flight["FL_NUMBER"]}</td><td>{flight["ORIGIN"]}</td><td>{flight["DEST"]}</td><td>{flight["AIR_TIME"]}</td><td>{flight["DISTANCE"]}</td></tr>'
                        output_html += '</table>'
                        document.getElementById('output').innerHTML = output_html
                    else:
                        document.getElementById('output').innerText = 'Failed to fetch or parse flight data'

        `);
        }
        main();
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('outDate').setAttribute('min', today);
        });
    </script>
</head>
<body>
    <h1>Flight Search and Delay Prediction Engine</h1>
    <form py-form>
        <label for="sourceAirportCode">Source Airport Code:</label>
        <input id="sourceAirportCode" name="sourceAirportCode" type="text" required>
        <label for="destinationAirportCode">Destination Airport Code:</label>
        <input id="destinationAirportCode" name="destinationAirportCode" type="text" required>
        <label for="outDate">Outbound Date:</label>
        <input id="outDate" name="outDate" type="date" required>
        <label for="classOfService">Class of Service:</label>
        <select id="classOfService" name="classOfService">
            <option value="ECONOMY">Economy</option>
            <option value="PREMIUM_ECONOMY">Premium Economy</option>
            <option value="BUSINESS">Business</option>
            <option value="FIRST">First Class</option>
        </select>
        <label for="sortOrder">Sort Order:</label>
        <select id="sortOrder" name="sortOrder">
            <option value="PRICE">Price</option>
            <option value="DEPARTURE_TIME">Departure Time</option>
            <option value="ARRIVAL_TIME">Arrival Time</option>
            <option value="DURATION">Duration</option>
        </select>
        <label for="itineraryType">Itinerary Type:</label>
        <select id="itineraryType" name="itineraryType">
            <option value="ONE_WAY">One Way</option>
            <option value="ROUND_TRIP">Round Trip</option>
        </select>
        <button type="button" onclick="triggerFetchAndDisplayFlights()">Search Flights</button>
    </form>
    <div id="output"></div>
    <script>
        // Define a function to trigger Python function via Pyodide
    function triggerFetchAndDisplayFlights() {
        if (!window.pyodide) {
            console.error("Pyodide is not loaded yet!");
            return;
        }
        try {
            window.pyodide.runPythonAsync('fetchAndDisplayFlights()');
        } catch (error) {
            console.error("Failed to run fetchAndDisplayFlights:", error);
        }
    }
    </script>
</body>
</html>
